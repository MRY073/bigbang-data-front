var D=(P,U,m)=>new Promise((I,E)=>{var T=f=>{try{h(m.next(f))}catch(K){E(K)}},r=f=>{try{h(m.throw(f))}catch(K){E(K)}},h=f=>f.done?I(f.value):Promise.resolve(f.value).then(T,r);h((m=m.apply(P,U)).next())});import{g2 as w,d as ie,a as C,M as ue,m as re,k as p,e as d,f as s,w as u,g as y,i as de,h as b,F as H,l as Y,b as G,j as $,u as j,gS as _e,A as pe,B as me,a9 as S,t as R,gT as q,fK as k,x as ve,gU as ge,fL as ye,_ as fe}from"./index-CrpkX2s8.js";const he=(P,U)=>w.request("put",`/api/product-items/${P}`,{data:U}),ke=P=>w.request("delete",`/api/product-items/${P}`),Ce={class:"custom-category-page"},be={class:"filter-section"},$e={class:"filter-left"},Ve={class:"table-wrapper"},xe={key:1,class:"no-image"},ze=["data-key"],Se={key:0,class:"edit-wrapper"},Ee={class:"edit-actions"},Pe=["onClick"],Ue={key:0},Te={key:1,class:"empty-text"},Oe=["data-key"],De={key:0,class:"edit-wrapper"},Ie={class:"edit-actions"},Ke=["onClick"],Be={key:0},Fe={key:1,class:"empty-text"},Ne=["data-key"],je={key:0,class:"edit-wrapper"},Ae={class:"edit-actions"},Le=["onClick"],Me={key:0},Re={key:1,class:"empty-text"},qe=["data-key"],Ge={key:0,class:"edit-wrapper"},He={class:"edit-actions"},Ye=["onClick"],we={key:0},Je={key:1,class:"empty-text"},Qe={key:0,class:"pagination-wrapper"},We="/api/product-items",Xe="/api/product-items/custom-categories",Ze=ie({name:"CustomCategory",__name:"index",setup(P){const U=[{label:"Modern Nest|泰国",value:"1489850435"},{label:"shop07|泰国",value:"1638595255"}],m=C(""),I=ue([]),E=C(!1),T=C(!1),r=C({}),h=C(1),f=C(20),K=[10,20,50,100],B=C(0),v=C({}),F=C([]),V=C(""),J=()=>D(null,null,function*(){if(m.value)try{const l=new URL(Xe,window.location.origin);l.searchParams.append("shopID",m.value);const e=yield fetch(l.toString(),{method:"GET"});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const a=yield e.json();if(a.success&&Array.isArray(a.data))X(W(a.data));else throw new Error(a.error||a.message||"获取分类失败")}catch(l){console.error("获取自定义分类选项失败:",l),k.error((l==null?void 0:l.message)||"获取自定义分类选项失败")}}),Q=["custom_category_1","custom_category_2","custom_category_3","custom_category_4"],W=l=>l.map(e=>{var a,n,c,o,_;return typeof e=="string"?e:e&&typeof e=="object"&&(_=(o=(c=(n=(a=e.label)!=null?a:e.name)!=null?n:e.value)!=null?c:e.key)!=null?o:e.id)!=null?_:""}).map(e=>typeof e=="string"?e.trim():"").filter(Boolean),X=l=>{if(!l.length)return;const e=new Set(F.value.map(n=>n.value));let a=!1;l.forEach(n=>{const c=n.trim();!c||e.has(c)||(F.value.push({label:c,value:c}),e.add(c),a=!0)}),a&&F.value.sort((n,c)=>n.label.localeCompare(c.label,"zh-Hans-CN"))};function Z(l="加载中..."){return ye.service({lock:!0,text:l,background:"rgba(0,0,0,0.2)"})}const N=(l=!0)=>D(null,null,function*(){if(!m.value){k.warning("请先选择店铺");return}l&&(h.value=1),T.value=!0;const e=Z("拉取数据中...");try{const a=U.find(_=>_.value===m.value);if(!a)throw new Error("店铺信息不存在");const n=new URL(We,window.location.origin);n.searchParams.append("shopID",m.value),n.searchParams.append("shopName",a.label),n.searchParams.append("page",h.value.toString()),n.searchParams.append("pageSize",f.value.toString()),V.value&&n.searchParams.append("customCategory",V.value);const c=yield fetch(n.toString());if(!c.ok)throw new Error(`HTTP error! status: ${c.status}`);const o=yield c.json();if(o.success&&o.data){const _=V.value?o.data.filter(O=>Q.some(g=>{const M=O[g];return typeof M=="string"&&M.includes(V.value)})):o.data;I.value=_,v.value={},r.value={},B.value=V.value?_.length:o.total||o.data.length,l&&k.success(o.message||`拉取成功，共 ${B.value} 条数据`)}else throw new Error(o.error||o.message||"拉取失败")}catch(a){console.error("拉取数据失败:",a),k.error((a==null?void 0:a.message)||"拉取失败，请稍后重试"),I.value=[],B.value=0}finally{e.close(),T.value=!1}}),ee=()=>{m.value&&(h.value=1,N())},te=()=>{F.value=[],V.value="",m.value&&J()};re(()=>{});const A=(l,e)=>D(null,null,function*(){const a=`${l.id||l.product_id}`;v.value[a]||(v.value[a]={});const n=e;r.value[a]||(r.value[a]={}),n in r.value[a]||(r.value[a][n]=l[n]),v.value[a][e]=!0,yield ve();const c=document.querySelector(`.editable-cell[data-field="${e}"][data-key="${a}"]`);if(c){const o=c.querySelector("input");o&&(o.focus(),o.select())}}),x=(l,e)=>{var c;const a=`${l.id||l.product_id}`;v.value[a]&&(v.value[a][e]=!1);const n=e;r.value[a]&&n in r.value[a]&&(l[n]=(c=r.value[a][n])!=null?c:null,delete r.value[a][n],Object.keys(r.value[a]).length===0&&delete r.value[a])},z=(l,e)=>D(null,null,function*(){var n,c;const a=`${l.id||l.product_id}`;if(!l.id&&!l.product_id){k.warning("商品ID不存在，无法保存");return}E.value=!0;try{const o={[e]:l[e]||null},_=l.id||l.product_id,O=yield he(_,o);if(O.success){k.success("保存成功"),v.value[a]&&(v.value[a][e]=!1);const g=e;r.value[a]&&g in r.value[a]&&(delete r.value[a][g],Object.keys(r.value[a]).length===0&&delete r.value[a])}else{k.error(O.message||"保存失败");const g=e;r.value[a]&&g in r.value[a]&&(l[g]=(n=r.value[a][g])!=null?n:null),v.value[a]&&(v.value[a][e]=!1)}}catch(o){console.error("保存失败:",o),k.error((o==null?void 0:o.message)||"保存失败，请稍后重试");const _=e;r.value[a]&&_ in r.value[a]&&(l[_]=(c=r.value[a][_])!=null?c:null),v.value[a]&&(v.value[a][e]=!1)}finally{E.value=!1}}),L=(l,e)=>{var n;const a=`${l.id||l.product_id}`;return((n=v.value[a])==null?void 0:n[e])===!0},ae=l=>D(null,null,function*(){try{yield ge.confirm(`确定要删除商品 "${l.product_name}" 吗？`,"提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),E.value=!0;const e=l.id||l.product_id,a=yield ke(e);a.success?(k.success("删除成功"),yield N()):k.error(a.message||"删除失败")}catch(e){e!=="cancel"&&(console.error("删除失败:",e),k.error((e==null?void 0:e.message)||"删除失败，请稍后重试"))}finally{E.value=!1}}),le=l=>{h.value=l,m.value&&N(!1)},se=l=>{f.value=l,h.value=1,m.value&&N(!1)};return(l,e)=>{const a=b("el-option"),n=b("el-select"),c=b("el-icon"),o=b("el-button"),_=b("el-table-column"),O=b("el-image"),g=b("el-input"),M=b("el-table"),oe=b("el-pagination"),ne=b("el-card"),ce=me("loading");return d(),p("div",Ce,[s(ne,{class:"category-card",shadow:"never"},{header:u(()=>[...e[5]||(e[5]=[y("div",{class:"card-header"},[y("span",{class:"card-title"},"自定义分类管理")],-1)])]),default:u(()=>[y("div",be,[y("div",$e,[s(n,{modelValue:m.value,"onUpdate:modelValue":e[0]||(e[0]=t=>m.value=t),placeholder:"请选择店铺",clearable:"",style:{width:"250px"},onChange:te},{default:u(()=>[(d(),p(H,null,Y(U,t=>s(a,{key:t.value,label:t.label,value:t.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),s(n,{modelValue:V.value,"onUpdate:modelValue":e[1]||(e[1]=t=>V.value=t),placeholder:"请选择自定义分类",clearable:"",style:{width:"220px"},onChange:ee},{default:u(()=>[(d(!0),p(H,null,Y(F.value,t=>(d(),G(a,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),s(o,{type:"primary",disabled:!m.value,loading:T.value,onClick:e[2]||(e[2]=()=>N())},{default:u(()=>[s(c,null,{default:u(()=>[s(j(_e))]),_:1}),e[6]||(e[6]=$(" 拉取商品 ",-1))]),_:1},8,["disabled","loading"])])]),y("div",Ve,[pe((d(),G(M,{data:I.value,stripe:"",border:"",style:{width:"100%"},"header-cell-style":{background:"var(--el-fill-color-light)",color:"var(--el-text-color-primary)",textAlign:"center"}},{default:u(()=>[s(_,{prop:"product_id",label:"商品ID",width:"150",align:"center","show-overflow-tooltip":""}),s(_,{prop:"product_name",label:"商品名称",width:"200",align:"center","show-overflow-tooltip":""}),s(_,{label:"商品图片",width:"120",align:"center"},{default:u(({row:t})=>[t.product_image?(d(),G(O,{key:0,src:t.product_image,"preview-src-list":[t.product_image],fit:"cover",style:{width:"80px",height:"80px","border-radius":"4px"},"preview-teleported":!0},null,8,["src","preview-src-list"])):(d(),p("span",xe,"暂无图片"))]),_:1}),s(_,{label:"自定义分类1",width:"200",align:"center"},{default:u(({row:t})=>[y("div",{class:"editable-cell","data-field":"custom_category_1","data-key":`${t.id||t.product_id}`},[L(t,"custom_category_1")?(d(),p("div",Se,[s(g,{modelValue:t.custom_category_1,"onUpdate:modelValue":i=>t.custom_category_1=i,placeholder:"请输入分类",size:"small",onKeyup:[S(i=>z(t,"custom_category_1"),["enter"]),S(i=>x(t,"custom_category_1"),["esc"])]},null,8,["modelValue","onUpdate:modelValue","onKeyup"]),y("div",Ee,[s(o,{link:"",type:"primary",size:"small",onClick:i=>z(t,"custom_category_1")},{default:u(()=>[...e[7]||(e[7]=[$(" 保存 ",-1)])]),_:1},8,["onClick"]),s(o,{link:"",size:"small",onClick:i=>x(t,"custom_category_1")},{default:u(()=>[...e[8]||(e[8]=[$(" 取消 ",-1)])]),_:1},8,["onClick"])])])):(d(),p("div",{key:1,class:"cell-content",onClick:i=>A(t,"custom_category_1")},[t.custom_category_1?(d(),p("span",Ue,R(t.custom_category_1),1)):(d(),p("span",Te,"点击编辑")),s(c,{class:"edit-icon"},{default:u(()=>[s(j(q))]),_:1})],8,Pe))],8,ze)]),_:1}),s(_,{label:"自定义分类2",width:"200",align:"center"},{default:u(({row:t})=>[y("div",{class:"editable-cell","data-field":"custom_category_2","data-key":`${t.id||t.product_id}`},[L(t,"custom_category_2")?(d(),p("div",De,[s(g,{modelValue:t.custom_category_2,"onUpdate:modelValue":i=>t.custom_category_2=i,placeholder:"请输入分类",size:"small",onKeyup:[S(i=>z(t,"custom_category_2"),["enter"]),S(i=>x(t,"custom_category_2"),["esc"])]},null,8,["modelValue","onUpdate:modelValue","onKeyup"]),y("div",Ie,[s(o,{link:"",type:"primary",size:"small",onClick:i=>z(t,"custom_category_2")},{default:u(()=>[...e[9]||(e[9]=[$(" 保存 ",-1)])]),_:1},8,["onClick"]),s(o,{link:"",size:"small",onClick:i=>x(t,"custom_category_2")},{default:u(()=>[...e[10]||(e[10]=[$(" 取消 ",-1)])]),_:1},8,["onClick"])])])):(d(),p("div",{key:1,class:"cell-content",onClick:i=>A(t,"custom_category_2")},[t.custom_category_2?(d(),p("span",Be,R(t.custom_category_2),1)):(d(),p("span",Fe,"点击编辑")),s(c,{class:"edit-icon"},{default:u(()=>[s(j(q))]),_:1})],8,Ke))],8,Oe)]),_:1}),s(_,{label:"自定义分类3",width:"200",align:"center"},{default:u(({row:t})=>[y("div",{class:"editable-cell","data-field":"custom_category_3","data-key":`${t.id||t.product_id}`},[L(t,"custom_category_3")?(d(),p("div",je,[s(g,{modelValue:t.custom_category_3,"onUpdate:modelValue":i=>t.custom_category_3=i,placeholder:"请输入分类",size:"small",onKeyup:[S(i=>z(t,"custom_category_3"),["enter"]),S(i=>x(t,"custom_category_3"),["esc"])]},null,8,["modelValue","onUpdate:modelValue","onKeyup"]),y("div",Ae,[s(o,{link:"",type:"primary",size:"small",onClick:i=>z(t,"custom_category_3")},{default:u(()=>[...e[11]||(e[11]=[$(" 保存 ",-1)])]),_:1},8,["onClick"]),s(o,{link:"",size:"small",onClick:i=>x(t,"custom_category_3")},{default:u(()=>[...e[12]||(e[12]=[$(" 取消 ",-1)])]),_:1},8,["onClick"])])])):(d(),p("div",{key:1,class:"cell-content",onClick:i=>A(t,"custom_category_3")},[t.custom_category_3?(d(),p("span",Me,R(t.custom_category_3),1)):(d(),p("span",Re,"点击编辑")),s(c,{class:"edit-icon"},{default:u(()=>[s(j(q))]),_:1})],8,Le))],8,Ne)]),_:1}),s(_,{label:"自定义分类4",width:"200",align:"center"},{default:u(({row:t})=>[y("div",{class:"editable-cell","data-field":"custom_category_4","data-key":`${t.id||t.product_id}`},[L(t,"custom_category_4")?(d(),p("div",Ge,[s(g,{modelValue:t.custom_category_4,"onUpdate:modelValue":i=>t.custom_category_4=i,placeholder:"请输入分类",size:"small",onKeyup:[S(i=>z(t,"custom_category_4"),["enter"]),S(i=>x(t,"custom_category_4"),["esc"])]},null,8,["modelValue","onUpdate:modelValue","onKeyup"]),y("div",He,[s(o,{link:"",type:"primary",size:"small",onClick:i=>z(t,"custom_category_4")},{default:u(()=>[...e[13]||(e[13]=[$(" 保存 ",-1)])]),_:1},8,["onClick"]),s(o,{link:"",size:"small",onClick:i=>x(t,"custom_category_4")},{default:u(()=>[...e[14]||(e[14]=[$(" 取消 ",-1)])]),_:1},8,["onClick"])])])):(d(),p("div",{key:1,class:"cell-content",onClick:i=>A(t,"custom_category_4")},[t.custom_category_4?(d(),p("span",we,R(t.custom_category_4),1)):(d(),p("span",Je,"点击编辑")),s(c,{class:"edit-icon"},{default:u(()=>[s(j(q))]),_:1})],8,Ye))],8,qe)]),_:1}),s(_,{label:"操作",width:"120",align:"center",fixed:"right"},{default:u(({row:t})=>[s(o,{link:"",type:"danger",size:"small",onClick:i=>ae(t)},{default:u(()=>[...e[15]||(e[15]=[$(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"])),[[ce,T.value]])]),B.value>0?(d(),p("div",Qe,[s(oe,{"current-page":h.value,"onUpdate:currentPage":e[3]||(e[3]=t=>h.value=t),"page-size":f.value,"onUpdate:pageSize":e[4]||(e[4]=t=>f.value=t),"page-sizes":K,total:B.value,background:!0,layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:le,onSizeChange:se},null,8,["current-page","page-size","total"])])):de("",!0)]),_:1})])}}}),at=fe(Ze,[["__scopeId","data-v-c132565e"]]);export{at as default};
