var U=(A,P,b)=>new Promise((E,T)=>{var g=h=>{try{S(b.next(h))}catch(M){T(M)}},H=h=>{try{S(b.throw(h))}catch(M){T(M)}},S=h=>h.done?E(h.value):Promise.resolve(h.value).then(g,H);S((b=b.apply(A,P)).next())});import{d as ye,M as be,a as v,p as j,m as Ye,k as f,e as _,f as i,w as p,g as c,i as we,h as D,F as Z,l as ee,b as Ce,j as O,v as De,t as z,q as te,fK as w,fL as Se,_ as Ve}from"./index-CrpkX2s8.js";const xe={class:"product-stage-page"},Te={class:"card-header"},Me={class:"left"},ke={class:"actions"},He={class:"filter-section"},Ue={class:"filter-inputs"},Pe={class:"filter-buttons"},Ee={class:"table-wrapper"},Fe={class:"sort-icon"},$e={key:0},Ne={key:1},Ie={key:2},Oe={class:"cell-center"},ze={key:1,class:"dash"},Le={class:"cell-center"},je=["onClick"],Ae={class:"cell-center"},Be=["onClick"],Ge={class:"cell-center"},Re=["src"],qe={key:1,class:"no-img"},Je={class:"save-actions"},Ke={class:"stage-editor"},Qe={class:"time-picker-group"},We={class:"stage-editor"},Xe={class:"time-picker-group"},Ze={class:"stage-editor"},et={class:"time-picker-group"},tt={class:"stage-editor"},at={class:"time-picker-group"},lt={class:"cell-center"},nt={key:0},ot={key:1,class:"dash"},st={key:0,class:"pagination-wrapper"},rt="/api/products",it="/api/products/stage",dt="/api/product-items/custom-categories",ct=ye({name:"ProductStageManual",__name:"index",setup(A){const P={testing:"测款阶段",potential:"潜力阶段",product:"成品阶段",abandoned:"放弃阶段"},b=be([]),E=v(!1),T=v("all"),g=v("1489850435"),H=v(""),S=v(""),h=v(""),M=v(""),y=v(1),F=v(20),ae=[10,20,50,100,200],C=v("default"),L=[{label:"Modern Nest|泰国",value:"1489850435"},{label:"shop07|泰国",value:"1638595255"}],B=["custom_category_1","custom_category_2","custom_category_3","custom_category_4"],$=v([]),k=v("");function le(l="加载中..."){return Se.service({lock:!0,text:l,background:"rgba(0,0,0,0.2)"})}function ne(l){return l.map(e=>{var s,r,t,n,o;return typeof e=="string"?e:e&&typeof e=="object"&&(o=(n=(t=(r=(s=e.label)!=null?s:e.name)!=null?r:e.value)!=null?t:e.key)!=null?n:e.id)!=null?o:""}).map(e=>typeof e=="string"?e.trim():"").filter(Boolean)}function G(l){if(!l.length)return;const e=new Set($.value.map(r=>r.value));let s=!1;l.forEach(r=>{const t=r.trim();!t||e.has(t)||($.value.push({label:t,value:t}),e.add(t),s=!0)}),s&&$.value.sort((r,t)=>r.label.localeCompare(t.label,"zh-Hans-CN"))}function oe(l){const e=[];return l.forEach(s=>{B.forEach(r=>{const t=s[r];if(typeof t=="string"){const n=t.trim();n&&e.push(n)}})}),e}function R(){return U(this,null,function*(){try{const l=new URL(dt,window.location.origin);g.value&&l.searchParams.append("shopID",g.value);const e=yield fetch(l.toString(),{method:"GET"});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const s=yield e.json();if(s.success&&Array.isArray(s.data))G(ne(s.data));else throw new Error(s.error||s.message||"获取自定义分类失败")}catch(l){console.error("获取自定义分类失败:",l)}})}function V(l){if(!l)return null;try{const e=new Date(l),s=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),t=String(e.getDate()).padStart(2,"0"),n=String(e.getHours()).padStart(2,"0"),o=String(e.getMinutes()).padStart(2,"0"),d=String(e.getSeconds()).padStart(2,"0");return`${s}-${r}-${t} ${n}:${o}:${d}`}catch(e){return null}}function x(l){if(!l||l.trim()==="")return null;try{const e=new Date(l);return isNaN(e.getTime())?null:e.toISOString()}catch(e){return null}}function se(l,e){if(!l.start_time||!l.end_time||!e.start_time||!e.end_time)return!1;try{const s=x(l.start_time),r=x(l.end_time),t=x(e.start_time),n=x(e.end_time);if(!s||!r||!t||!n)return!1;const o=new Date(s),d=new Date(r),m=new Date(t),Y=new Date(n);return o>=m&&o<=Y||d>=m&&d<=Y||o<=m&&d>=Y}catch(s){return!1}}function re(l){const e=["testing","potential","product","abandoned"],s=[];for(let r=0;r<e.length;r++)for(let t=r+1;t<e.length;t++){const n=e[r],o=e[t],d=l[`${n}_stage`],m=l[`${o}_stage`];se(d,m)&&s.push([n,o])}return s}function q(l){const e=new Date,s=["abandoned","product","potential","testing"];for(const r of s){const t=l[`${r}_stage`];if(t!=null&&t.start_time&&(t!=null&&t.end_time))try{const n=x(t.start_time),o=x(t.end_time);if(n&&o){const d=new Date(n),m=new Date(o);if(!isNaN(d.getTime())&&!isNaN(m.getTime())&&d<=e&&e<=m)return r}}catch(n){}}return null}function ie(l){b.value=l.map(e=>{var n,o,d,m,Y,N,a,u;const s=B.map(I=>{var X;return(X=e[I])!=null?X:""}).map(I=>typeof I=="string"?I.trim():"").filter(Boolean),r=s.join(" / "),t={product_id:e.product_id,product_name:e.product_name,product_image:e.product_image,testing_stage:{start_time:V(((n=e.testing_stage)==null?void 0:n.start_time)||null),end_time:V(((o=e.testing_stage)==null?void 0:o.end_time)||null)},potential_stage:{start_time:V(((d=e.potential_stage)==null?void 0:d.start_time)||null),end_time:V(((m=e.potential_stage)==null?void 0:m.end_time)||null)},product_stage:{start_time:V(((Y=e.product_stage)==null?void 0:Y.start_time)||null),end_time:V(((N=e.product_stage)==null?void 0:N.end_time)||null)},abandoned_stage:{start_time:V(((a=e.abandoned_stage)==null?void 0:a.start_time)||null),end_time:V(((u=e.abandoned_stage)==null?void 0:u.end_time)||null)},savingFlags:{testing:!1,potential:!1,product:!1,abandoned:!1},currentStage:null,customCategories:s,customCategoriesText:r};return t.currentStage=q(t),t})}function de(){return U(this,null,function*(){if(!g.value){w.warning("请先选择店铺");return}E.value=!0;const l=le("拉取数据中...");try{const e=L.find(o=>o.value===g.value);if(!e)throw new Error("店铺信息不存在");const s=new URL(rt,window.location.origin);s.searchParams.append("shopID",g.value),s.searchParams.append("shopName",e.label),k.value&&s.searchParams.append("customCategory",k.value);const r=s.toString(),t=yield fetch(r);if(!t.ok){const o=yield t.text();throw console.error("HTTP错误响应内容:",o),new Error(`HTTP error! status: ${t.status}`)}const n=yield t.json();if(n.success&&n.data)ie(n.data),G(oe(n.data)),y.value=1,w.success(n.message||`数据拉取成功，共 ${b.value.length} 条`);else throw console.error("数据验证失败:",{success:n.success,hasData:!!n.data,error:n.error,message:n.message}),new Error(n.error||n.message||"查询失败")}catch(e){console.error("拉取数据失败:",e),w.error((e==null?void 0:e.message)||"网络连接失败，请检查网络后重试"),b.value=[]}finally{l.close(),E.value=!1}})}function ce(l,e,s,r){return U(this,null,function*(){const t=L.find(Y=>Y.value===g.value);if(!t)throw new Error("店铺信息不存在");const n=x(s),o=x(r),d=yield fetch(it,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({product_id:l,shopID:g.value,shopName:t.label,stage_type:e,start_time:n,end_time:o})});if(!d.ok)throw new Error(`HTTP error! status: ${d.status}`);const m=yield d.json();if(!m.success)throw new Error(m.error||m.message||"更新失败")})}function ue(l){return U(this,null,function*(){if(!g.value){w.warning("请先选择店铺");return}const e=b.value.find(t=>t.product_id===l);if(!e){w.error("商品不存在");return}const s=re(e);if(s.length>0){const t=s.map(([n,o])=>`${P[n]}和${P[o]}`).join("、");w.error(`时间段重叠：${t}的时间段存在重叠，请检查后重试`);return}const r=["testing","potential","product","abandoned"];r.forEach(t=>{e.savingFlags[t]=!0});try{const t=r.map(n=>{const o=e[`${n}_stage`];return ce(l,n,o.start_time,o.end_time)});yield Promise.all(t),e.currentStage=q(e),w.success("保存成功")}catch(t){console.error("保存阶段失败:",t),w.error((t==null?void 0:t.message)||"保存失败，请检查网络后重试")}finally{r.forEach(t=>{e.savingFlags[t]=!1})}})}const J=j(()=>{const l=b.value;if(l.length===0)return[];let e;if(T.value==="all")e=l;else{const t=T.value;e=l.filter(n=>{const o=n[`${t}_stage`],d=(o==null?void 0:o.start_time)&&(o==null?void 0:o.end_time),m=n.currentStage===t;return d||m})}if(k.value){const t=k.value.trim();e=e.filter(n=>n.customCategories.some(o=>o.trim()===t))}const s=h.value.trim();if(s){const t=s.toLowerCase();e=e.filter(n=>n.product_id.toLowerCase().includes(t))}const r=M.value.trim();if(r){const t=r.toLowerCase();e=e.filter(n=>n.product_name.toLowerCase().includes(t))}return C.value!=="default"&&(e=e.slice().sort((t,n)=>{const o=t.currentStage||"",d=n.currentStage||"";return!o&&!d?0:o?d?C.value==="asc"?o.localeCompare(d):d.localeCompare(o):-1:1})),e}),pe=j(()=>{const l=J.value,e=(y.value-1)*F.value,s=e+F.value;return l.slice(e,s)}),K=j(()=>J.value.length);function me(l){y.value=l}function ge(l){F.value=l,y.value=1}function Q(l){return U(this,null,function*(){try{if(navigator.clipboard&&navigator.clipboard.writeText)yield navigator.clipboard.writeText(l);else{const e=document.createElement("textarea");e.value=l,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)}w.success("已复制到剪贴板")}catch(e){w.error("复制失败")}})}function _e(){h.value=H.value,M.value=S.value,y.value=1}function fe(){H.value="",S.value="",h.value="",M.value="",y.value=1}function ve(){C.value==="default"?C.value="asc":C.value==="asc"?C.value="desc":C.value="default",y.value=1}function he(){y.value=1}function W(){$.value=[],k.value="",g.value&&R(),y.value=1}return watch(g,()=>{W()}),Ye(()=>{g.value&&R()}),(l,e)=>{const s=D("el-option"),r=D("el-select"),t=D("el-button"),n=D("el-input"),o=D("el-table-column"),d=D("el-date-picker"),m=D("el-table"),Y=D("el-pagination"),N=D("el-card");return _(),f("div",xe,[i(N,{class:"stage-card"},{default:p(()=>[c("div",Te,[c("div",Me,[i(r,{modelValue:T.value,"onUpdate:modelValue":e[0]||(e[0]=a=>T.value=a),placeholder:"筛选阶段",style:{width:"220px"}},{default:p(()=>[i(s,{label:"全部",value:"all"}),i(s,{label:"测款阶段",value:"testing"}),i(s,{label:"潜力阶段",value:"potential"}),i(s,{label:"成品阶段",value:"product"}),i(s,{label:"放弃阶段",value:"abandoned"})]),_:1},8,["modelValue"]),i(r,{modelValue:k.value,"onUpdate:modelValue":e[1]||(e[1]=a=>k.value=a),placeholder:"自定义分类",clearable:"",filterable:"",style:{width:"220px"},onChange:he},{default:p(()=>[(_(!0),f(Z,null,ee($.value,a=>(_(),Ce(s,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),c("div",ke,[i(r,{modelValue:g.value,"onUpdate:modelValue":e[2]||(e[2]=a=>g.value=a),placeholder:"选择店铺",style:{width:"200px","margin-right":"12px"},onChange:W},{default:p(()=>[(_(),f(Z,null,ee(L,a=>i(s,{key:a.value,label:a.label,value:a.value},null,8,["label","value"])),64))]),_:1},8,["modelValue"]),i(t,{type:"primary",loading:E.value,icon:"el-icon-refresh",onClick:de},{default:p(()=>[...e[7]||(e[7]=[O("拉取数据",-1)])]),_:1},8,["loading"])])]),c("div",He,[c("div",Ue,[i(n,{modelValue:H.value,"onUpdate:modelValue":e[3]||(e[3]=a=>H.value=a),placeholder:"产品ID",clearable:"",style:{width:"200px","margin-right":"12px"}},null,8,["modelValue"]),i(n,{modelValue:S.value,"onUpdate:modelValue":e[4]||(e[4]=a=>S.value=a),placeholder:"产品名称",clearable:"",style:{width:"200px","margin-right":"12px"}},null,8,["modelValue"])]),c("div",Pe,[i(t,{type:"primary",onClick:_e},{default:p(()=>[...e[8]||(e[8]=[O("筛选",-1)])]),_:1}),i(t,{onClick:fe},{default:p(()=>[...e[9]||(e[9]=[O("取消筛选",-1)])]),_:1})])]),c("div",Ee,[i(m,{data:pe.value,stripe:"",style:{width:"100%"},"row-key":a=>a.product_id,"row-class-name":({row:a})=>a.currentStage==="abandoned"?"row-abandoned":"","max-height":600},{default:p(()=>[i(o,{prop:"currentStage",label:"当前阶段",width:"140",align:"center","header-align":"center",fixed:"left"},{header:p(()=>[c("div",{class:"sortable-header",onClick:ve},[e[10]||(e[10]=c("span",null,"当前阶段",-1)),c("span",Fe,[C.value==="default"?(_(),f("span",$e,"⇅")):C.value==="asc"?(_(),f("span",Ne,"↑")):(_(),f("span",Ie,"↓"))])])]),default:p(({row:a})=>[c("div",Oe,[a.currentStage?(_(),f("span",{key:0,class:De(`current-badge stage-${a.currentStage}`)},z(P[a.currentStage]||a.currentStage),3)):(_(),f("span",ze,"-"))])]),_:1}),i(o,{prop:"product_id",label:"产品ID",width:"160",align:"center","header-align":"center",fixed:"left"},{default:p(({row:a})=>[c("div",Le,[c("span",{class:"plain-text",title:"点击复制",onClick:te(u=>Q(a.product_id),["stop"])},z(a.product_id),9,je)])]),_:1}),i(o,{prop:"product_name",label:"产品名称",width:"300",align:"center","header-align":"center",fixed:"left"},{default:p(({row:a})=>[c("div",Ae,[c("span",{class:"plain-text",title:"点击复制",onClick:te(u=>Q(a.product_name),["stop"])},z(a.product_name),9,Be)])]),_:1}),i(o,{prop:"product_image",label:"产品主图",width:"120",align:"center","header-align":"center",fixed:"left"},{default:p(({row:a})=>[c("div",Ge,[a.product_image?(_(),f("img",{key:0,src:a.product_image,alt:"主图",class:"thumb"},null,8,Re)):(_(),f("div",qe,"无图"))])]),_:1}),i(o,{label:"操作",width:"120",align:"center","header-align":"center",fixed:"left"},{default:p(({row:a})=>[c("div",Je,[i(t,{type:"primary",size:"small",loading:a.savingFlags.testing||a.savingFlags.potential||a.savingFlags.product||a.savingFlags.abandoned,onClick:u=>ue(a.product_id)},{default:p(()=>[...e[11]||(e[11]=[O("保存",-1)])]),_:1},8,["loading","onClick"])])]),_:1}),i(o,{label:"测款阶段",width:"280",align:"center","header-align":"center"},{default:p(({row:a})=>[c("div",Ke,[c("div",Qe,[i(d,{modelValue:a.testing_stage.start_time,"onUpdate:modelValue":u=>a.testing_stage.start_time=u,type:"datetime",placeholder:"开始时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px","margin-bottom":"8px"}},null,8,["modelValue","onUpdate:modelValue"]),i(d,{modelValue:a.testing_stage.end_time,"onUpdate:modelValue":u=>a.testing_stage.end_time=u,type:"datetime",placeholder:"结束时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px"}},null,8,["modelValue","onUpdate:modelValue"])])])]),_:1}),i(o,{label:"潜力阶段",width:"280",align:"center","header-align":"center"},{default:p(({row:a})=>[c("div",We,[c("div",Xe,[i(d,{modelValue:a.potential_stage.start_time,"onUpdate:modelValue":u=>a.potential_stage.start_time=u,type:"datetime",placeholder:"开始时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px","margin-bottom":"8px"}},null,8,["modelValue","onUpdate:modelValue"]),i(d,{modelValue:a.potential_stage.end_time,"onUpdate:modelValue":u=>a.potential_stage.end_time=u,type:"datetime",placeholder:"结束时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px"}},null,8,["modelValue","onUpdate:modelValue"])])])]),_:1}),i(o,{label:"成品阶段",width:"280",align:"center","header-align":"center"},{default:p(({row:a})=>[c("div",Ze,[c("div",et,[i(d,{modelValue:a.product_stage.start_time,"onUpdate:modelValue":u=>a.product_stage.start_time=u,type:"datetime",placeholder:"开始时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px","margin-bottom":"8px"}},null,8,["modelValue","onUpdate:modelValue"]),i(d,{modelValue:a.product_stage.end_time,"onUpdate:modelValue":u=>a.product_stage.end_time=u,type:"datetime",placeholder:"结束时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px"}},null,8,["modelValue","onUpdate:modelValue"])])])]),_:1}),i(o,{label:"放弃阶段",width:"280",align:"center","header-align":"center"},{default:p(({row:a})=>[c("div",tt,[c("div",at,[i(d,{modelValue:a.abandoned_stage.start_time,"onUpdate:modelValue":u=>a.abandoned_stage.start_time=u,type:"datetime",placeholder:"开始时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px","margin-bottom":"8px"}},null,8,["modelValue","onUpdate:modelValue"]),i(d,{modelValue:a.abandoned_stage.end_time,"onUpdate:modelValue":u=>a.abandoned_stage.end_time=u,type:"datetime",placeholder:"结束时间","value-format":"YYYY-MM-DD HH:mm:ss",format:"YYYY-MM-DD HH:mm:ss",clearable:"",style:{width:"140px"}},null,8,["modelValue","onUpdate:modelValue"])])])]),_:1}),i(o,{label:"自定义分类","min-width":"220",align:"center","header-align":"center",fixed:"right"},{default:p(({row:a})=>[c("div",lt,[a.customCategoriesText&&a.customCategoriesText.length?(_(),f("span",nt,z(a.customCategoriesText),1)):(_(),f("span",ot,"-"))])]),_:1})]),_:1},8,["data","row-key","row-class-name"])]),K.value>0?(_(),f("div",st,[i(Y,{"current-page":y.value,"onUpdate:currentPage":e[5]||(e[5]=a=>y.value=a),"page-size":F.value,"onUpdate:pageSize":e[6]||(e[6]=a=>F.value=a),"page-sizes":ae,total:K.value,background:!0,layout:"total, sizes, prev, pager, next, jumper",onCurrentChange:me,onSizeChange:ge},null,8,["current-page","page-size","total"])])):we("",!0)]),_:1})])}}}),mt=Ve(ct,[["__scopeId","data-v-bf82bdcc"]]);export{mt as default};
